-- ============================================================================
-- 3. VOTEKICK LOGIC (SECURITY)
-- ============================================================================

local function IsStranger(player)
    for _, name in pairs(MY_ACCOUNTS) do
        if player.Name == name then return false end
    end
    return true
end

local function VoteYes()
    pcall(function() VoteKickRemotes.VoteYes.Send({ Voter = tostring(LocalPlayer.UserId), Amount = 0 }) end)
end

local function VoteNo()
    pcall(function() VoteKickRemotes.VoteNo.Send({ Voter = tostring(LocalPlayer.UserId), Amount = 0 }) end)
end

local function InitiateKick(targetPlayer)
    task.wait(math.random() * 0.5)
    print("Initiating Kick: " .. targetPlayer.Name)
    local prefix = "\r\n\x00"
    local payloadString = prefix .. tostring(targetPlayer.UserId)
    local args = { buffer.fromstring(payloadString), nil }
    pcall(function() ByteNet:FireServer(unpack(args)) end)
end

VoteKickRemotes.StartVote.Listen(function(data)
    local targetId = tonumber(data.TargetUserId)
    local p = Players:GetPlayerByUserId(targetId)
    if p and IsStranger(p) then VoteYes()
    elseif not p then VoteYes()
    else VoteNo() end
end)

-- *** SMART SCANNER ***
local function ScanAndKick()
    local strangerFound = false
    local totalPlayers = 0
    local myAccountCount = 0
    
    for _, p in pairs(Players:GetPlayers()) do
        totalPlayers = totalPlayers + 1
        if not IsStranger(p) then myAccountCount = myAccountCount + 1 end
    end
    
    if myAccountCount < MIN_ACCOUNTS_TO_KICK then return totalPlayers, false end

    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and IsStranger(p) then
            strangerFound = true
            task.spawn(function() InitiateKick(p) end)
        end
    end
    
    if strangerFound then getgenv().PauseFarm = true else getgenv().PauseFarm = false end
    return totalPlayers, strangerFound
end

local function OnPlayerAdded(player)
    if IsStranger(player) then
        getgenv().PauseFarm = true
        task.wait(2); ScanAndKick()
    else
        task.wait(1); ScanAndKick()
    end
end
local pAddedConn = Players.PlayerAdded:Connect(OnPlayerAdded)
table.insert(getgenv().FarmConnections, pAddedConn)

-- *** STARTUP & WATCHDOG ***
local myRunID = getgenv().CurrentRunID

task.spawn(function()
    print("Startup: Waiting " .. STARTUP_DELAY .. "s...")
    task.wait(STARTUP_DELAY)
    print("Startup: Executing first scan.")
    ScanAndKick()
end)

task.spawn(function()
    while task.wait(10) do
        if getgenv().CurrentRunID ~= myRunID then break end
        local count, strangers = ScanAndKick()
        if count >= 14 and not strangers then
            print("Server Full & Safe. Stopping Watchdog Loop.")
            break 
        end
    end
end)

local pRemovedConn = Players.PlayerRemoving:Connect(function(player)
    task.wait(0.5) 
    
    -- We use the return values from ScanAndKick to be certain
    local _, strangerFound = ScanAndKick() 
    
    -- ONLY resume if NO strangers are left at all
    if not strangerFound then
        getgenv().PauseFarm = false -- Double-confirming it's false
        if Workspace:GetAttribute("GameState") == "Round In Progress" then
            print("✅ Server Clean. Resuming Farm.")
            TryKill()
        end
    else
        print("⚠️ A player left, but another stranger is still here. Staying paused.")
    end
end)

table.insert(getgenv().FarmConnections, pRemovedConn)

-- ============================================================================
-- 4. FARM LOGIC (LOSER - RESET ENABLED)
-- ============================================================================

local function TryJoinTeam()
    task.spawn(function()
        for i = 1, 10 do 
            if LocalPlayer.Team and LocalPlayer.Team.Name == "Terrorists" then break end
            local args = { buffer.fromstring(TEAM_STRING), nil }
            ByteNet:FireServer(unpack(args))
            task.wait(1)
        end
    end)
end

local function TryKill()
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("Humanoid") and char.Humanoid.Health > 0 then
        local args = { buffer.fromstring(RESET_STRING), nil }
        ByteNet:FireServer(unpack(args))
    end
end

local function OnStateChanged()
    local state = Workspace:GetAttribute("GameState")
    
    if state == "Intermission" or state == "Warmup" then
        TryJoinTeam()
    elseif state == "Round In Progress" then
        -- Don't kill if we are busy kicking a stranger
        if getgenv().PauseFarm then return end 
        TryKill()
    end
end
local stateConn = Workspace:GetAttributeChangedSignal("GameState"):Connect(OnStateChanged)
table.insert(getgenv().FarmConnections, stateConn)

local function DestroyMap(child)
    if child.Name == "Map" then
        task.delay(0.1, function() if child then child:Destroy() end end)
    end
end
local mapConn = Workspace.ChildAdded:Connect(DestroyMap)
table.insert(getgenv().FarmConnections, mapConn)

if Workspace:FindFirstChild("Map") then Workspace.Map:Destroy() end
Lighting:ClearAllChildren()

local function handleCharacter(char)
    task.spawn(function()
        local root = char:WaitForChild("HumanoidRootPart", 10)
        if root then
            task.wait(0.1)
            root.Anchored = true 
            root.Velocity = Vector3.new(0,0,0)
        end
    end)
    -- Mid-Game Kill Check
    if Workspace:GetAttribute("GameState") == "Round In Progress" then
        task.wait(0.5); TryKill()
    end
end
local charConn = LocalPlayer.CharacterAdded:Connect(handleCharacter)
table.insert(getgenv().FarmConnections, charConn)
if LocalPlayer.Character then handleCharacter(LocalPlayer.Character) end

local function OnPlayerCharAdded(char)
    if char.Name ~= LocalPlayer.Name then task.wait(); char:Destroy() end
end
for _, player in pairs(Players:GetPlayers()) do
    if player ~= LocalPlayer then
        local conn = player.CharacterAdded:Connect(OnPlayerCharAdded)
        table.insert(getgenv().FarmConnections, conn)
        if player.Character then player.Character:Destroy() end
    end
end
local pAddC = Players.PlayerAdded:Connect(function(player)
    local conn = player.CharacterAdded:Connect(OnPlayerCharAdded)
    table.insert(getgenv().FarmConnections, conn)
end)
table.insert(getgenv().FarmConnections, pAddC)
