-- ============================================================================
-- 1. CONFIGURATION & CLEANUP (CT-SIDE)
-- ============================================================================

-- A. YOUR ACCOUNT WHITELIST
local MY_ACCOUNTS = {
    "GymCinnabun", "HazeYungWasp", "N9CCI5LUELVJPLUt", 
    "LiraNadirCarry", "AFKAdlington", "BossUpBloxDawg",
    "YoNewbNewt", "ResidentCarry", "TravelerSmurf",
    "FlickFloret21", "SteelZeroEZ", "EchoBroPlayoff",
    "TrollTheOwl", "AzureRblxMedal"
}

-- B. SETTINGS
local TEAM_STRING = "s\x12\x00Counter-Terrorists"
local MIN_ACCOUNTS_TO_KICK = 5 -- Only kick if 5+ of your accounts are here
local STARTUP_DELAY = 10       -- Wait 10s on inject before kicking

-- C. SERVER HOPPER SETTINGS
local HOPPER_ENABLED = false -- Set to true to enable Priority Check
local TARGET_PLACE_ID = 114234929420007
local GITHUB_URL = "https://raw.githubusercontent.com/Michael-Kambayashi/Server/refs/heads/main/list"
local CHECK_INTERVAL = 300 

-- D. CLEANUP
if getgenv().FarmConnections then
    for _, connection in pairs(getgenv().FarmConnections) do
        connection:Disconnect()
    end
end
getgenv().FarmConnections = {}
getgenv().PauseFarm = false 
getgenv().CurrentRunID = math.random(1, 10000000)

-- ============================================================================
-- 2. SERVICES & PRIORITY CHECK
-- ============================================================================
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Lighting = game:GetService("Lighting")
local TeleportService = game:GetService("TeleportService")
local LocalPlayer = Players.LocalPlayer

-- *** PRIORITY SERVER CHECK ***
-- This runs BEFORE any other logic.
if HOPPER_ENABLED then
    print("PRIORITY CHECK: Verifying Server ID from GitHub...")
    local success, result = pcall(function()
        return game:HttpGet(GITHUB_URL)
    end)

    if success and result then
        local targetId = result:gsub("%s+", "") -- Remove whitespace
        
        -- If ID is valid (>10 chars) AND we are not in that server:
        if #targetId > 10 and targetId ~= game.JobId then
            print("WRONG SERVER DETECTED!")
            print("Current: " .. game.JobId)
            print("Target : " .. targetId)
            print("Teleporting immediately. Script halted.")
            
            TeleportService:TeleportToPlaceInstance(TARGET_PLACE_ID, targetId, LocalPlayer)
            
            return -- CRITICAL: Stops the rest of the script from loading!
        else
            print("Correct Server ID Confirmed. Starting Farm...")
        end
    else
        warn("GitHub Check Failed (Network Error). Proceeding with farm anyway.")
    end
else
    print("Priority Hopper Disabled. Starting Farm...")
end

-- If we passed the check, load the rest...
RunService:Set3dRenderingEnabled(false)

local ByteNet = ReplicatedStorage:WaitForChild("ByteNetReliable")
local RemotesModule = require(ReplicatedStorage.Database.Security.Remotes)
local VoteKickRemotes = RemotesModule.VoteKick

print("--- CT (WINNER) ZERO-LOOP FARM + HOPPER STARTED ---")

-- ============================================================================
-- 3. VOTEKICK LOGIC (SECURITY)
-- ============================================================================

local function IsStranger(player)
    for _, name in pairs(MY_ACCOUNTS) do
        if player.Name == name then return false end
    end
    return true
end

local function VoteYes()
    pcall(function() VoteKickRemotes.VoteYes.Send({ Voter = tostring(LocalPlayer.UserId), Amount = 0 }) end)
end

local function VoteNo()
    pcall(function() VoteKickRemotes.VoteNo.Send({ Voter = tostring(LocalPlayer.UserId), Amount = 0 }) end)
end

local function InitiateKick(targetPlayer)
    task.wait(math.random() * 0.5)
    print("Initiating Kick: " .. targetPlayer.Name)
    
    local prefix = "\r\n\x00"
    local payloadString = prefix .. tostring(targetPlayer.UserId)
    local args = { buffer.fromstring(payloadString), nil }
    pcall(function() ByteNet:FireServer(unpack(args)) end)
end

-- EVENT: Vote Started
VoteKickRemotes.StartVote.Listen(function(data)
    local targetId = tonumber(data.TargetUserId)
    local p = Players:GetPlayerByUserId(targetId)
    
    if p and IsStranger(p) then VoteYes()
    elseif not p then VoteYes()
    else VoteNo() end
end)

-- *** SMART SCANNER ***
local function ScanAndKick()
    local strangerFound = false
    local totalPlayers = 0
    local myAccountCount = 0
    
    -- Count Friendlies
    for _, p in pairs(Players:GetPlayers()) do
        totalPlayers = totalPlayers + 1
        if not IsStranger(p) then myAccountCount = myAccountCount + 1 end
    end
    
    -- Check Threshold
    if myAccountCount < MIN_ACCOUNTS_TO_KICK then return totalPlayers, false end

    -- Kick Strangers
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and IsStranger(p) then
            strangerFound = true
            task.spawn(function() InitiateKick(p) end)
        end
    end
    
    if strangerFound then getgenv().PauseFarm = true else getgenv().PauseFarm = false end
    return totalPlayers, strangerFound
end

-- EVENT: New Player Joined
local function OnPlayerAdded(player)
    if IsStranger(player) then
        getgenv().PauseFarm = true
        task.wait(2) 
        ScanAndKick()
    else
        task.wait(1)
        ScanAndKick()
    end
end
local pAddedConn = Players.PlayerAdded:Connect(OnPlayerAdded)
table.insert(getgenv().FarmConnections, pAddedConn)

-- *** STARTUP & WATCHDOG ***
local myRunID = getgenv().CurrentRunID

-- 1. Initial Delayed Start
task.spawn(function()
    print("Startup: Waiting " .. STARTUP_DELAY .. "s...")
    task.wait(STARTUP_DELAY)
    print("Startup: Executing first scan.")
    ScanAndKick()
end)

-- 2. Watchdog Loop
task.spawn(function()
    while task.wait(10) do
        if getgenv().CurrentRunID ~= myRunID then break end
        
        local count, strangers = ScanAndKick()
        
        -- Auto-Kill Watchdog if server is full (14) and safe
        if count >= 14 and not strangers then
            print("Server Full & Safe. Stopping Watchdog Loop.")
            break 
        end
    end
end)

-- ============================================================================
-- 4. FARM LOGIC
-- ============================================================================

local function TryJoinTeam()
    task.spawn(function()
        for i = 1, 10 do 
            if LocalPlayer.Team and LocalPlayer.Team.Name == "Counter-Terrorists" then break end
            local args = { buffer.fromstring(TEAM_STRING), nil }
            ByteNet:FireServer(unpack(args))
            task.wait(1)
        end
    end)
end

local function OnStateChanged()
    local state = Workspace:GetAttribute("GameState")
    if state == "Intermission" or state == "Warmup" then
        TryJoinTeam()
    end
end
local stateConn = Workspace:GetAttributeChangedSignal("GameState"):Connect(OnStateChanged)
table.insert(getgenv().FarmConnections, stateConn)

local function DestroyMap(child)
    if child.Name == "Map" then
        task.delay(0.1, function() if child then child:Destroy() end end)
    end
end
local mapConn = Workspace.ChildAdded:Connect(DestroyMap)
table.insert(getgenv().FarmConnections, mapConn)

if Workspace:FindFirstChild("Map") then Workspace.Map:Destroy() end
Lighting:ClearAllChildren()

local function handleCharacter(char)
    task.spawn(function()
        local root = char:WaitForChild("HumanoidRootPart", 10)
        if root then
            task.wait(0.1)
            root.Anchored = true 
            root.Velocity = Vector3.new(0,0,0)
        end
    end)
end
local charConn = LocalPlayer.CharacterAdded:Connect(handleCharacter)
table.insert(getgenv().FarmConnections, charConn)
if LocalPlayer.Character then handleCharacter(LocalPlayer.Character) end

local function OnPlayerCharAdded(char)
    if char.Name ~= LocalPlayer.Name then task.wait(); char:Destroy() end
end
for _, player in pairs(Players:GetPlayers()) do
    if player ~= LocalPlayer then
        local conn = player.CharacterAdded:Connect(OnPlayerCharAdded)
        table.insert(getgenv().FarmConnections, conn)
        if player.Character then player.Character:Destroy() end
    end
end
local pAddC = Players.PlayerAdded:Connect(function(player)
    local conn = player.CharacterAdded:Connect(OnPlayerCharAdded)
    table.insert(getgenv().FarmConnections, conn)
end)
table.insert(getgenv().FarmConnections, pAddC)

-- ============================================================================
-- 5. BACKGROUND HOPPER CHECK
-- ============================================================================
-- This keeps checking in case the target ID changes WHILE we are playing
if HOPPER_ENABLED then
	task.spawn(function()
		while true do
			task.wait(CHECK_INTERVAL)
			local success, result = pcall(function() return game:HttpGet(GITHUB_URL) end)
			if success and result then
				local newId = result:gsub("%s+", "")
				if #newId > 10 and newId ~= game.JobId then
					print("HOPPER: New GitHub ID Detected! Moving...")
					TeleportService:TeleportToPlaceInstance(TARGET_PLACE_ID, newId, LocalPlayer)
				end
			end
		end
	end)
end

-- ============================================================================
-- 6. SMART SESSION REFRESH (STRICT 2-MAP DELAY)
-- ============================================================================
task.spawn(function()
    -- 1. Initial Wait (~13 Minutes)
    -- The script sleeps here. It ignores everything until this time is up.
    local waitTime = REFRESH_TIME + math.random(1, 120)
    print("Session Refresh Timer started: " .. math.floor(waitTime/60) .. " minutes.")
    task.wait(waitTime)
    
    print("Timer Reached. Waiting for the 2nd 'Map Voting' session...")
    
    -- 2. Strict Counter Logic
    local mapVoteCount = 0
    local targetCount = 2 -- We want to see Map Voting twice before leaving
    
    while mapVoteCount < targetCount do
        -- Wait specifically for the state to CHANGE
        Workspace:GetAttributeChangedSignal("GameState"):Wait()
        local state = Workspace:GetAttribute("GameState")
        
        -- Only count "Map Voting". Ignore "Game Ending" to prevent double counts.
        if state == "Map Voting" then
            mapVoteCount = mapVoteCount + 1
            print("Map Voting detected (" .. mapVoteCount .. "/" .. targetCount .. ")")
            
            if mapVoteCount >= targetCount then
                break -- We hit the 2nd time, time to leave.
            end
            
            -- IMPORTANT: Wait until this specific Map Voting session IS OVER.
            -- This prevents the script from counting the same session multiple times.
            while Workspace:GetAttribute("GameState") == "Map Voting" do
                task.wait(1)
            end
            print("   > Map Voting finished. Waiting for next match...")
        end
    end
    
    -- 3. Rejoin Same Server
    print("2nd Map Voting hit. Refreshing Session Now...")
    TeleportService:TeleportToPlaceInstance(game.PlaceId, game.JobId, LocalPlayer)
end)

-- ============================================================================
-- 7. STARTUP CHECK
-- ============================================================================
local currentState = Workspace:GetAttribute("GameState")
if currentState == "Intermission" or currentState == "Warmup" then
    TryJoinTeam()
end
